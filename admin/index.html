<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Orders Admin</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <main class="wrap">
    <h1>Orders Admin</h1>

    <div class="controls">
      <input id="q" placeholder="Search name / phone / ORD…" />
      <select id="pickup">
        <option value="">Pickup: Any</option>
        <option value="Yes">Pickup: Yes</option>
        <option value="No">Pickup: No</option>
      </select>
      <select id="paid">
        <option value="">Paid: Any</option>
        <option value="Yes">Paid: Yes</option>
        <option value="No">Paid: No</option>
      </select>
      <input id="from" type="date" />
      <input id="to" type="date" />
      <button id="searchBtn">Search</button>
      <button id="clearBtn">Clear dates</button>
      <button id="signoutBtn" class="right">Sign out</button>
    </div>

    <p id="meta"></p>
    <div id="list"></div>
  </main>

<script>
/* ---------- BASIC AUTH HELPER ---------- */
/* We store a Base64 "username:password" in sessionStorage so every fetch carries it. */
const BASIC_KEY_STORAGE = 'admin_basic_b64';

/* Prompt once if we don't have creds yet */
function ensureBasicCreds() {
  let b64 = sessionStorage.getItem(BASIC_KEY_STORAGE);
  if (!b64) {
    const raw = window.prompt('Enter "username:password" for admin (e.g. admin:Testing)');
    if (!raw) throw new Error('No credentials entered');
    b64 = btoa(raw.trim());
    sessionStorage.setItem(BASIC_KEY_STORAGE, b64);
  }
  return b64;
}

/* Add Authorization header to every call */
async function apiSearch(params) {
  const b64 = ensureBasicCreds();
  const url = new URL('/api/search-orders', location.origin);
  Object.entries(params).forEach(([k,v]) => { if (v) url.searchParams.set(k, v); });

  const res = await fetch(url, {
    headers: { 'Authorization': 'Basic ' + b64 }
  });

  if (res.status === 401) {
    // creds wrong or expired
    sessionStorage.removeItem(BASIC_KEY_STORAGE);
    throw new Error('unauthorized');
  }
  if (!res.ok) throw new Error('Server error ' + res.status);
  return res.json();
}

/* ---------- UI ---------- */
const els = {
  q:      document.getElementById('q'),
  pickup: document.getElementById('pickup'),
  paid:   document.getElementById('paid'),
  from:   document.getElementById('from'),
  to:     document.getElementById('to'),
  search: document.getElementById('searchBtn'),
  clear:  document.getElementById('clearBtn'),
  meta:   document.getElementById('meta'),
  list:   document.getElementById('list'),
  signout:document.getElementById('signoutBtn'),
};

function badge(text) {
  const b = document.createElement('span');
  b.className = 'badge';
  b.textContent = text;
  return b;
}

function orderCard(o) {
  const card = document.createElement('div');
  card.className = 'card';

  const h = document.createElement('div');
  h.className = 'card-h';
  h.innerHTML = `<div><div class="name">${o.name}</div>
                 <a href="tel:${o.phone}">${o.phone}</a>
                 <div class="ts">${new Date(o.timestamp).toLocaleString()}</div></div>`;
  const right = document.createElement('div');
  right.appendChild(badge(o.orderId));
  right.appendChild(badge(o.paid === 'Yes' ? 'Paid' : 'Unpaid'));
  h.appendChild(right);
  card.appendChild(h);

  const items = document.createElement('div');
  items.className = 'chips';
  for (const it of (o.items || [])) {
    // it looks like: { qty, itemName, category }
    items.appendChild(badge(`${it.qty}× ${it.itemName} (${it.category})`));
  }
  card.appendChild(items);

  const foot = document.createElement('div');
  foot.className = 'card-f';
  foot.innerHTML = `Pickup: <b>${o.pickup || '—'}</b>${o.deliveryNote ? ' • Note: ' + o.deliveryNote : ''}`;
  card.appendChild(foot);

  return card;
}

async function runSearch() {
  els.meta.textContent = '';
  els.list.innerHTML = '';
  try {
    const data = await apiSearch({
      q: els.q.value.trim(),
      pickup: els.pickup.value,
      paid: els.paid.value,
      from: els.from.value,
      to: els.to.value
    });
    els.meta.textContent = `Showing ${data.rows.length} of ${data.total} order(s)`;
    data.rows.forEach(o => els.list.appendChild(orderCard(o)));
  } catch (e) {
    els.meta.textContent = 'Error: ' + e.message;
  }
}

els.search.addEventListener('click', runSearch);
els.clear.addEventListener('click', () => { els.from.value=''; els.to.value=''; });
els.signout.addEventListener('click', () => { sessionStorage.removeItem(BASIC_KEY_STORAGE); location.reload(); });

/* Auto-run on load */
runSearch();
</script>
</body>
</html>
