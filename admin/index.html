<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Orders Admin</title>
  <style>
    :root { color-scheme: dark; }
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#0f1115;color:#e6e6ea}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    h1{margin:0 0 16px 0;font-size:32px}
    .controls{display:flex;flex-wrap:wrap;gap:12px;align-items:center;margin-bottom:16px}
    .controls input,.controls select{background:#1a1d24;color:#e6e6ea;border:1px solid #2a2f3a;border-radius:10px;padding:10px 12px;outline:none}
    .controls button{background:#2563eb;border:0;color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer}
    .controls .right{margin-left:auto;background:#394150}
    #meta{margin:8px 0 16px 0;opacity:.8}
    .card{background:#12151b;border:1px solid #232836;border-radius:14px;margin:12px 0;padding:14px}
    .card-h{display:flex;justify-content:space-between;gap:12px;align-items:center}
    .name{font-size:20px;font-weight:700;margin-bottom:4px}
    .card a{color:#9ec1ff;text-decoration:none}
    .ts{opacity:.75;font-size:13px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0}
    .badge{display:inline-block;padding:6px 10px;border-radius:999px;background:#1b2030;border:1px solid #2a3144;font-size:13px}
    .badge.positive{background:#0f2b1f;border-color:#1d3f2e;color:#8ef0b2}
    .badge.warn{background:#2d1b1b;border-color:#3f2a2a;color:#ffb4b4}
    .card-f{font-size:14px;opacity:.9}
    @media (max-width:640px){.controls .right{margin-left:0}}
  </style>
</head>
<body>
  <main class="wrap">
    <h1>Orders Admin</h1>

    <div class="controls">
      <input id="q" placeholder="Search name / phone / ORD…" />
      <select id="pickup">
        <option value="">Pickup: Any</option>
        <option value="Yes">Pickup: Yes</option>
        <option value="No">Pickup: No</option>
      </select>
      <select id="paid">
        <option value="">Paid: Any</option>
        <option value="Yes">Paid: Yes</option>
        <option value="No">Paid: No</option>
      </select>
      <input id="from" type="date" />
      <input id="to" type="date" />
      <button id="searchBtn">Search</button>
      <button id="clearBtn">Clear dates</button>
      <button id="signoutBtn" class="right">Sign out</button>
    </div>

    <p id="meta"></p>
    <div id="list"></div>
  </main>

<script>
/* ============ Basic Authorization (unchanged behavior) ============ */
const BASIC_KEY_STORAGE = 'admin_basic_b64';

function ensureBasicCreds() {
  let b64 = sessionStorage.getItem(BASIC_KEY_STORAGE);
  if (!b64) {
    const raw = prompt('Enter admin credentials as username:password\n(e.g.  admin:Testing )');
    if (!raw) throw new Error('No credentials provided');
    b64 = btoa(raw.trim());
    sessionStorage.setItem(BASIC_KEY_STORAGE, b64);
  }
  return b64;
}

async function apiSearch(params) {
  const b64 = ensureBasicCreds();
  const url = new URL('/api/search-orders', location.origin);
  Object.entries(params).forEach(([k,v]) => { if (v) url.searchParams.set(k, v); });

  const res = await fetch(url.toString(), {
    headers: { 'Authorization': 'Basic ' + b64 }
  });

  if (res.status === 401) {
    sessionStorage.removeItem(BASIC_KEY_STORAGE);
    throw new Error('unauthorized');
  }
  if (!res.ok) throw new Error('Server error ' + res.status);
  return res.json();
}

/* ---------------- UI helpers (hardened) ---------------- */
const els = {
  q:      document.getElementById('q'),
  pickup: document.getElementById('pickup'),
  paid:   document.getElementById('paid'),
  from:   document.getElementById('from'),
  to:     document.getElementById('to'),
  search: document.getElementById('searchBtn'),
  clear:  document.getElementById('clearBtn'),
  meta:   document.getElementById('meta'),
  list:   document.getElementById('list'),
  signout:document.getElementById('signoutBtn'),
};

function yesish(v){
  const s = String(v ?? '').trim().toLowerCase();
  return s === 'yes' || s === 'y' || s === 'true' || s === 'paid';
}

function badge(text, cls=''){ const b=document.createElement('span'); b.className='badge '+cls; b.textContent=text; return b; }

function orderCard(o){
  const card = document.createElement('div'); card.className='card';

  const head = document.createElement('div'); head.className='card-h';
  head.innerHTML = `<div>
      <div class="name">${o.name || ''}</div>
      <a href="tel:${o.phone||''}">${o.phone||''}</a>
      <div class="ts">${o.timestamp ? new Date(o.timestamp).toLocaleString() : ''}</div>
    </div>`;
  const right = document.createElement('div');
  right.appendChild(badge(o.orderId || ''));
  const paidYes = yesish(o.paid ?? o.paidVal);
  right.appendChild(badge(paidYes ? 'Paid' : 'Unpaid', paidYes ? 'positive' : 'warn'));
  head.appendChild(right);
  card.appendChild(head);

  const chips = document.createElement('div'); chips.className='chips';
  // Robust field fallbacks so labels never show "undefined"
  (o.items || []).forEach(it => {
    const qty = it.qty ?? it.q ?? 0;
    const name = it.itemName ?? it.item ?? it.product ?? it.header ?? it.name ?? '—';
    const cat = it.category ?? it.cat ?? '';
    chips.appendChild(badge(`${qty}× ${name}${cat ? ` (${cat})` : ''}`));
  });
  card.appendChild(chips);

  const foot = document.createElement('div'); foot.className='card-f';
  foot.innerHTML = `Pickup: <b>${o.pickup || '—'}</b>${o.deliveryNote ? ' • Note: ' + o.deliveryNote : ''}`;
  card.appendChild(foot);

  return card;
}

async function runSearch(){
  els.meta.textContent=''; els.list.innerHTML='';
  try{
    const data = await apiSearch({
      q: els.q.value.trim(),
      pickup: els.pickup.value,
      paid: els.paid.value,
      from: els.from.value,
      to: els.to.value
    });
    els.meta.textContent = `Showing ${data.rows?.length ?? 0} of ${data.total ?? 0} order(s)`;
    (data.rows || []).forEach(o => els.list.appendChild(orderCard(o)));
  }catch(err){
    els.meta.textContent = 'Error: ' + err.message;
  }
}

els.search.addEventListener('click', runSearch);
els.clear.addEventListener('click', () => { els.from.value=''; els.to.value=''; });
els.signout.addEventListener('click', () => { sessionStorage.removeItem(BASIC_KEY_STORAGE); location.reload(); });

// initial load
runSearch();
</script>
</body>
</html>
